<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Revenue Task Force 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--purple:#5b21b6;--purple-light:#7c3aed;--purple-dark:#3b0764;--gold:#f59e0b;--green:#059669;--red:#dc2626;--bg:#f5f3ff;--card:#fff;--text:#1e1b4b;--muted:#6b7280;--border:#ddd6fe;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:80px;}

/* Header */
.header-bar{background:linear-gradient(135deg,var(--purple-dark) 0%,var(--purple) 60%,var(--purple-light) 100%);height:8px;}
.form-header{background:white;border-bottom:1px solid var(--border);padding:16px 20px;box-shadow:0 2px 8px rgba(91,33,182,0.08);}
.form-header-inner{max-width:680px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
.form-header h1{font-family:'Space Mono',monospace;font-size:1.2rem;color:var(--purple-dark);}
.form-header .meta{font-size:0.76rem;color:var(--muted);}
.header-right{display:flex;align-items:center;gap:8px;flex-shrink:0;}
.hdr-btn{display:flex;align-items:center;gap:4px;padding:6px 12px;border-radius:6px;font-family:'Inter',sans-serif;font-size:0.76rem;font-weight:700;cursor:pointer;border:none;white-space:nowrap;text-decoration:none;}
.hdr-btn.dark{background:#1e1b4b;color:white;}

/* Offline banner */
.offline-banner{background:#fef3c7;border-bottom:1px solid #fcd34d;padding:8px 20px;text-align:center;font-size:0.8rem;font-weight:600;color:#92400e;display:none;}
.offline-banner.show{display:block;}
.queue-badge{background:#dc2626;color:white;border-radius:10px;padding:1px 7px;font-size:0.7rem;margin-left:5px;}

/* Sync dot */
.sync-dot{width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:4px;vertical-align:middle;}
.sync-dot.synced{background:#10b981;animation:pulse 2s infinite;}
.sync-dot.syncing{background:#f59e0b;}
.sync-dot.offline{background:#ef4444;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.3;}}

/* Container */
.container{max-width:680px;margin:0 auto;padding:18px 16px;display:flex;flex-direction:column;gap:14px;}
.card{background:var(--card);border-radius:12px;padding:22px;box-shadow:0 1px 4px rgba(91,33,182,0.08);border:1px solid var(--border);}
.section-header{background:linear-gradient(135deg,var(--purple-dark),var(--purple));color:white;padding:13px 20px;border-radius:10px 10px 0 0;font-family:'Space Mono',monospace;font-size:0.86rem;font-weight:700;letter-spacing:0.5px;margin:-22px -22px 18px -22px;}
.field-group{display:flex;flex-direction:column;gap:5px;margin-bottom:14px;}
.field-group:last-child{margin-bottom:0;}
label{font-size:0.85rem;font-weight:600;color:var(--text);}
label .req{color:var(--red);margin-left:2px;}
input[type="text"],input[type="tel"],input[type="number"],select,textarea{width:100%;padding:9px 13px;border:1.5px solid var(--border);border-radius:8px;font-family:'Inter',sans-serif;font-size:0.9rem;color:var(--text);background:#faf9ff;transition:border-color 0.2s,box-shadow 0.2s;outline:none;-webkit-appearance:none;appearance:none;}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b7280' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 13px center;padding-right:34px;cursor:pointer;}
input:focus,select:focus,textarea:focus{border-color:var(--purple-light);box-shadow:0 0 0 3px rgba(124,58,237,0.12);background:white;}
input[readonly]{background:#f0fdf4;border-color:#a7f3d0;color:#065f46;font-family:'Space Mono',monospace;font-size:0.76rem;}

/* Other reveal */
.other-field{display:none;margin-top:7px;animation:slideDown 0.2s ease;}
.other-field.visible{display:flex;flex-direction:column;gap:5px;}
@keyframes slideDown{from{opacity:0;transform:translateY(-5px);}to{opacity:1;transform:translateY(0);}}
.other-field input{border-color:var(--gold);background:#fffbeb;}
.other-label{font-size:0.78rem;color:#92400e;font-weight:600;}

/* Type selector */
.type-selector{display:grid;grid-template-columns:1fr 1fr;gap:11px;margin-top:8px;}
.type-btn{border:2px solid var(--border);background:#faf9ff;border-radius:10px;padding:16px 10px;cursor:pointer;text-align:center;transition:all 0.2s;display:flex;flex-direction:column;align-items:center;gap:7px;}
.type-btn:hover{border-color:var(--purple-light);background:#f5f3ff;}
.type-btn.active{border-color:var(--purple);background:#ede9fe;box-shadow:0 0 0 3px rgba(124,58,237,0.15);}
.type-btn .icon{font-size:1.9rem;line-height:1;}
.type-btn .lbl{font-weight:700;font-size:0.9rem;color:var(--purple-dark);}
.type-btn .desc{font-size:0.72rem;color:var(--muted);line-height:1.3;}

/* GPS */
.gps-section{background:#f0fdf4;border:1.5px solid #a7f3d0;border-radius:10px;padding:14px;margin-bottom:16px;}
.gps-section h4{font-size:0.85rem;font-weight:700;color:#065f46;margin-bottom:10px;}
.gps-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:11px;background:var(--green);color:white;border:none;border-radius:8px;font-family:'Inter',sans-serif;font-size:0.9rem;font-weight:700;cursor:pointer;transition:background 0.2s,transform 0.1s;margin-bottom:10px;}
.gps-btn:hover{background:#047857;}
.gps-btn:active{transform:scale(0.98);}
.gps-btn:disabled{background:#9ca3af;cursor:not-allowed;}
.gps-btn .spinner{width:15px;height:15px;border:2px solid rgba(255,255,255,0.4);border-top-color:white;border-radius:50%;animation:spin 0.8s linear infinite;display:none;}
.gps-btn.loading .spinner{display:block;}
.gps-btn.loading .btn-text{display:none;}
@keyframes spin{to{transform:rotate(360deg);}}
.map-container{border-radius:8px;overflow:hidden;margin-bottom:10px;border:1.5px solid #a7f3d0;display:none;}
.map-container>div{height:200px;width:100%;}
.gps-fields{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:7px;}
.gps-note{font-size:0.71rem;color:#065f46;margin-top:5px;}
.accuracy-badge{display:inline-flex;align-items:center;gap:4px;font-size:0.7rem;padding:3px 8px;border-radius:20px;font-weight:600;margin-top:5px;}
.accuracy-badge.good{background:#dcfce7;color:#166534;}
.accuracy-badge.moderate{background:#fef9c3;color:#854d0e;}
.accuracy-badge.poor{background:#fee2e2;color:#991b1b;}

/* Sections */
.form-section{display:none;animation:fadeIn 0.3s ease;}
.form-section.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

/* Buttons */
.btn-row{display:flex;gap:9px;align-items:center;margin-top:8px;}
.btn-submit{flex:1;padding:13px;background:linear-gradient(135deg,var(--purple-dark),var(--purple-light));color:white;border:none;border-radius:10px;font-family:'Inter',sans-serif;font-size:0.93rem;font-weight:700;cursor:pointer;transition:opacity 0.2s;}
.btn-submit:hover{opacity:0.9;}
.btn-clear{padding:13px 15px;background:none;border:1.5px solid var(--border);border-radius:10px;font-family:'Inter',sans-serif;font-size:0.86rem;color:var(--muted);cursor:pointer;}
.btn-clear:hover{border-color:var(--red);color:var(--red);}
.status-msg{padding:10px 13px;border-radius:8px;font-size:0.84rem;font-weight:500;display:none;margin-top:9px;}
.status-msg.error{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;display:block;}
.status-msg.info{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe;display:block;}

/* Progress */
.progress-bar{height:4px;background:var(--border);border-radius:2px;margin-bottom:4px;overflow:hidden;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--gold));border-radius:2px;transition:width 0.4s ease;width:0%;}
.step-label{font-size:0.71rem;color:var(--muted);font-family:'Space Mono',monospace;}

/* Success */
.success-screen{display:none;text-align:center;padding:32px 22px;}
.success-screen.show{display:block;}
.success-icon{width:68px;height:68px;background:#dcfce7;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8rem;margin:0 auto 16px;animation:popIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275);}
@keyframes popIn{from{transform:scale(0);opacity:0;}to{transform:scale(1);opacity:1;}}
.success-screen h2{font-family:'Space Mono',monospace;color:var(--purple-dark);margin-bottom:7px;}
.success-screen p{color:var(--muted);font-size:0.86rem;margin-bottom:18px;}
.btn-new{padding:11px 22px;background:var(--purple);color:white;border:none;border-radius:8px;font-family:'Inter',sans-serif;font-size:0.88rem;font-weight:700;cursor:pointer;}

@media(max-width:480px){
  .type-selector{grid-template-columns:1fr;}
  .gps-fields{grid-template-columns:1fr;}
  .form-header h1{font-size:1rem;}
}
</style>
</head>
<body>

<div class="offline-banner" id="offlineBanner">
  ‚ö†Ô∏è You are offline. Records are saved and will sync when connected.
  <span class="queue-badge" id="queueCount">0</span> pending
</div>

<div class="header-bar"></div>
<div class="form-header">
  <div class="form-header-inner">
    <div>
      <h1>Revenue Task Force 2026</h1>
      <div class="meta">Cape Coast Metropolitan Assembly &nbsp;¬∑&nbsp; Field Data Collection</div>
    </div>
    <div class="header-right">
      <span style="font-size:0.72rem;color:var(--muted);font-family:'Space Mono',monospace;">
        <span class="sync-dot" id="syncDot"></span><span id="syncLabel">--</span>
      </span>
      <a href="admin.html" class="hdr-btn dark">üîê Admin</a>
    </div>
  </div>
</div>

<div class="container">

  <div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="step-label" id="stepLabel">Step 1 of 2 ‚Äî Select Revenue Type</div>
  </div>

  <!-- STEP 1 -->
  <div class="card" id="step1">
    <div class="field-group">
      <label>Revenue Type <span class="req">*</span></label>
      <p style="font-size:0.8rem;color:var(--muted);margin-bottom:8px;">Select the category for this record.</p>
      <div class="type-selector">
        <div class="type-btn" id="btn-business" onclick="selectType('business')">
          <div class="icon">üè™</div>
          <div class="lbl">Business</div>
          <div class="desc">Operating permit mobilization</div>
        </div>
        <div class="type-btn" id="btn-property" onclick="selectType('property')">
          <div class="icon">üè†</div>
          <div class="lbl">New Property</div>
          <div class="desc">Property rates issuance</div>
        </div>
      </div>
    </div>
  </div>

  <!-- BUSINESS -->
  <div class="card form-section" id="section-business">
    <div class="section-header">üè™ Business Details</div>
    <div class="field-group">
      <label for="b-name">Business Name <span class="req">*</span></label>
      <input type="text" id="b-name" placeholder="Enter business name"/>
    </div>
    <div class="field-group">
      <label for="b-owner">Owner's Name</label>
      <input type="text" id="b-owner" placeholder="Enter owner's full name"/>
    </div>
    <div class="field-group">
      <label for="b-contact">Contacts <span class="req">*</span></label>
      <input type="tel" id="b-contact" placeholder="e.g. 0244 123 456"/>
    </div>
    <div class="field-group">
      <label for="b-type">Business Type</label>
      <select id="b-type" onchange="handleOther(this,'b-type-other')">
        <option value="">-- Choose --</option>
        <option>Retail / Trading</option>
        <option>Food &amp; Beverage</option>
        <option>Professional Services</option>
        <option>Manufacturing</option>
        <option>Transport &amp; Logistics</option>
        <option>Education</option>
        <option>Health &amp; Pharmacy</option>
        <option>ICT / Telecom</option>
        <option>Hospitality / Hotel</option>
        <option>Construction</option>
        <option value="Other">Other</option>
      </select>
      <div class="other-field" id="b-type-other">
        <label class="other-label">‚Ü≥ Specify Business Type</label>
        <input type="text" id="b-type-other-val" placeholder="Describe..."/>
      </div>
    </div>
    <div class="field-group">
      <label for="b-size">Business Size</label>
      <select id="b-size" onchange="handleOther(this,'b-size-other')">
        <option value="">-- Choose --</option>
        <option>Micro (1‚Äì5 employees)</option>
        <option>Small (6‚Äì29 employees)</option>
        <option>Medium (30‚Äì99 employees)</option>
        <option>Large (100+ employees)</option>
        <option value="Other">Other</option>
      </select>
      <div class="other-field" id="b-size-other">
        <label class="other-label">‚Ü≥ Specify Business Size</label>
        <input type="text" id="b-size-other-val" placeholder="Describe..."/>
      </div>
    </div>
    <div class="field-group">
      <label for="b-item">Item / Product / Service <span class="req">*</span></label>
      <input type="text" id="b-item" placeholder="e.g. Electronics, Tailoring, Pharmacy..."/>
    </div>
    <div class="gps-section">
      <h4>üìç Exact Location (GPS)</h4>
      <button class="gps-btn" id="b-gps-btn" onclick="captureGPS('b')">
        <div class="spinner"></div>
        <span class="btn-text">üì° Capture My Current Location</span>
      </button>
      <div class="map-container" id="b-map-container"><div id="b-map"></div></div>
      <div class="gps-fields">
        <div class="field-group" style="margin:0"><label>Latitude</label><input type="text" id="b-lat" readonly placeholder="Auto-captured"/></div>
        <div class="field-group" style="margin:0"><label>Longitude</label><input type="text" id="b-lng" readonly placeholder="Auto-captured"/></div>
      </div>
      <div class="field-group" style="margin-bottom:5px"><label>Address</label><input type="text" id="b-address" readonly placeholder="Auto-filled"/></div>
      <div class="field-group" style="margin:0"><label>Plus Code</label><input type="text" id="b-pluscode" readonly placeholder="Auto-filled"/></div>
      <div id="b-accuracy" style="margin-top:6px;"></div>
      <p class="gps-note">üìå Drag the pin to fine-tune position if GPS drifts.</p>
    </div>
    <div class="btn-row">
      <button class="btn-submit" onclick="submitForm('business')">‚úì Submit Business Record</button>
      <button class="btn-clear" onclick="clearForm('business')">Clear</button>
    </div>
    <div id="b-status" class="status-msg"></div>
  </div>

  <!-- PROPERTY -->
  <div class="card form-section" id="section-property">
    <div class="section-header">üè† Property Details</div>
    <div class="field-group">
      <label for="p-owner">Property Owner's Name <span class="req">*</span></label>
      <input type="text" id="p-owner" placeholder="Enter owner's full name"/>
    </div>
    <div class="field-group">
      <label for="p-house">House Number / GPS Address</label>
      <input type="text" id="p-house" placeholder="e.g. C22/4 or GH-0001-1234"/>
    </div>
    <div class="field-group">
      <label for="p-ghana">Ghana Card Number</label>
      <input type="text" id="p-ghana" placeholder="GHA-XXXXXXXXX-X"/>
    </div>
    <div class="field-group">
      <label for="p-contact">Contact <span class="req">*</span></label>
      <input type="tel" id="p-contact" placeholder="e.g. 0244 123 456"/>
    </div>
    <div class="field-group">
      <label for="p-suburb">Suburb</label>
      <input type="text" id="p-suburb" placeholder="e.g. Ola, Abura, Pedu, Kotokuraba..."/>
    </div>
    <div class="field-group">
      <label for="p-building-type">Building Type</label>
      <select id="p-building-type" onchange="handleOther(this,'p-building-type-other')">
        <option value="">-- Choose --</option>
        <option>Detached</option>
        <option>Semi-Detached</option>
        <option>Storey-building</option>
        <option>Compound House</option>
        <option value="Other">Other</option>
      </select>
      <div class="other-field" id="p-building-type-other">
        <label class="other-label">‚Ü≥ Specify Building Type</label>
        <input type="text" id="p-building-type-other-val" placeholder="Describe..."/>
      </div>
    </div>
    <div class="field-group">
      <label for="p-rooms">Number of Rooms</label>
      <input type="number" id="p-rooms" placeholder="e.g. 5" min="0"/>
    </div>
    <div class="field-group">
      <label for="p-floors">Number of Floors</label>
      <select id="p-floors" onchange="handleOther(this,'p-floors-other')">
        <option value="">-- Choose --</option>
        <option>Single Storey</option>
        <option>2 Floors</option>
        <option>3 Floors</option>
        <option>4+ Floors</option>
        <option value="Other">Other</option>
      </select>
      <div class="other-field" id="p-floors-other">
        <label class="other-label">‚Ü≥ Specify Floors</label>
        <input type="text" id="p-floors-other-val" placeholder="Describe..."/>
      </div>
    </div>
    <div class="field-group">
      <label for="p-use">Current Use of Property</label>
      <select id="p-use" onchange="handleOther(this,'p-use-other')">
        <option value="">-- Choose --</option>
        <option>Owner Occupied</option>
        <option>Rented Out</option>
        <option>Mixed (Owner + Tenant)</option>
        <option>Vacant</option>
        <option>Under Development</option>
        <option value="Other">Other</option>
      </select>
      <div class="other-field" id="p-use-other">
        <label class="other-label">‚Ü≥ Specify Current Use</label>
        <input type="text" id="p-use-other-val" placeholder="Describe..."/>
      </div>
    </div>
    <div class="gps-section">
      <h4>üìç Exact Location (GPS)</h4>
      <button class="gps-btn" id="p-gps-btn" onclick="captureGPS('p')">
        <div class="spinner"></div>
        <span class="btn-text">üì° Capture My Current Location</span>
      </button>
      <div class="map-container" id="p-map-container"><div id="p-map"></div></div>
      <div class="gps-fields">
        <div class="field-group" style="margin:0"><label>Latitude</label><input type="text" id="p-lat" readonly placeholder="Auto-captured"/></div>
        <div class="field-group" style="margin:0"><label>Longitude</label><input type="text" id="p-lng" readonly placeholder="Auto-captured"/></div>
      </div>
      <div class="field-group" style="margin-bottom:5px"><label>Address</label><input type="text" id="p-address" readonly placeholder="Auto-filled"/></div>
      <div class="field-group" style="margin:0"><label>Plus Code</label><input type="text" id="p-pluscode" readonly placeholder="Auto-filled"/></div>
      <div id="p-accuracy" style="margin-top:6px;"></div>
      <p class="gps-note">üìå Drag the pin to fine-tune position if GPS drifts.</p>
    </div>
    <div class="btn-row">
      <button class="btn-submit" onclick="submitForm('property')">‚úì Submit Property Record</button>
      <button class="btn-clear" onclick="clearForm('property')">Clear</button>
    </div>
    <div id="p-status" class="status-msg"></div>
  </div>

  <!-- SUCCESS -->
  <div class="card success-screen" id="successScreen">
    <div class="success-icon">‚úÖ</div>
    <h2>Submitted!</h2>
    <p id="successMsg">Record saved successfully.</p>
    <button class="btn-new" onclick="resetAll()">+ Add Another Record</button>
  </div>

</div>

<script>
// ============================================================
const APPS_SCRIPT_URL    = 'https://script.google.com/macros/s/AKfycbwxFxfJloKO-sjeokue_rE2uNWLzuAL3j_kH4s_szMv5U-IrQhxvUeFmiCeLnC2Q61R3Q/exec';
const GOOGLE_MAPS_API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY'; // optional
// ============================================================

let currentType = null;
let offlineQueue = [];
let sessionCount = 0;
let maps = {}, markers = {}, geocoder = null, mapsLoaded = false;

// ---- Init ----
function init() {
  try { offlineQueue = JSON.parse(localStorage.getItem('rtf2026_queue') || '[]'); } catch(e) { offlineQueue = []; }
  updateSyncStatus();
  setupNetworkListeners();
  tryFlushQueue();
  loadGoogleMaps();
}

// ---- Network / offline queue ----
function setupNetworkListeners() {
  window.addEventListener('online',  () => { updateSyncStatus(); tryFlushQueue(); });
  window.addEventListener('offline', () => updateSyncStatus());
}

function updateSyncStatus() {
  const dot    = document.getElementById('syncDot');
  const label  = document.getElementById('syncLabel');
  const banner = document.getElementById('offlineBanner');
  const q = offlineQueue.length;
  if (!navigator.onLine) {
    dot.className = 'sync-dot offline';
    label.textContent = 'Offline';
    banner.classList.add('show');
    document.getElementById('queueCount').textContent = q;
  } else if (q > 0) {
    dot.className = 'sync-dot syncing';
    label.textContent = `Syncing ${q}...`;
    banner.classList.add('show');
    document.getElementById('queueCount').textContent = q;
  } else {
    dot.className = 'sync-dot synced';
    label.textContent = 'Live';
    banner.classList.remove('show');
  }
}

async function tryFlushQueue() {
  if (!navigator.onLine || offlineQueue.length === 0 || APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') return;
  const toSend = [...offlineQueue];
  for (const record of toSend) {
    try {
      await fetch(APPS_SCRIPT_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(record) });
      offlineQueue = offlineQueue.filter(r => r._id !== record._id);
      localStorage.setItem('rtf2026_queue', JSON.stringify(offlineQueue));
      updateSyncStatus();
    } catch(e) { break; }
  }
}

// ---- Google Maps ----
function loadGoogleMaps() {
  if (GOOGLE_MAPS_API_KEY === 'YOUR_GOOGLE_MAPS_API_KEY') return;
  const s = document.createElement('script');
  s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=onMapsReady`;
  s.async = true;
  document.head.appendChild(s);
}
window.onMapsReady = function() { mapsLoaded = true; geocoder = new google.maps.Geocoder(); };

function captureGPS(prefix) {
  const btn = document.getElementById(`${prefix}-gps-btn`);
  btn.classList.add('loading'); btn.disabled = true;
  if (!navigator.geolocation) {
    showGPSError(prefix, 'Geolocation not supported on this device.');
    btn.classList.remove('loading'); btn.disabled = false; return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude: lat, longitude: lng, accuracy: acc } = pos.coords;
    document.getElementById(`${prefix}-lat`).value = lat.toFixed(7);
    document.getElementById(`${prefix}-lng`).value = lng.toFixed(7);
    const cls = acc < 15 ? 'good' : acc < 50 ? 'moderate' : 'poor';
    const txt = acc < 15 ? '‚úì High Accuracy' : acc < 50 ? '~ Moderate Accuracy' : '‚ö† Low Accuracy';
    document.getElementById(`${prefix}-accuracy`).innerHTML =
      `<span class="accuracy-badge ${cls}">GPS: ¬±${Math.round(acc)}m &nbsp;${txt}</span>`;
    btn.classList.remove('loading'); btn.disabled = false;
    btn.querySelector('.btn-text').textContent = 'üîÑ Recapture Location';
    if (mapsLoaded) initMap(prefix, lat, lng);
    else reverseGeocodeNominatim(prefix, lat, lng);
  }, err => {
    btn.classList.remove('loading'); btn.disabled = false;
    const msg = err.code === 1 ? 'Location permission denied. Enable GPS in browser settings.'
              : err.code === 2 ? 'GPS signal unavailable. Try moving to an open area.'
              : 'GPS timed out. Please try again.';
    showGPSError(prefix, msg);
  }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
}

function initMap(prefix, lat, lng) {
  document.getElementById(`${prefix}-map-container`).style.display = 'block';
  const pos = { lat, lng };
  const map = new google.maps.Map(document.getElementById(`${prefix}-map`), {
    zoom: 18, center: pos, mapTypeId: 'hybrid',
    mapTypeControl: false, streetViewControl: false, fullscreenControl: false
  });
  const marker = new google.maps.Marker({ position: pos, map, draggable: true, animation: google.maps.Animation.DROP });
  maps[prefix] = map; markers[prefix] = marker;
  marker.addListener('dragend', () => {
    const p = marker.getPosition();
    document.getElementById(`${prefix}-lat`).value = p.lat().toFixed(7);
    document.getElementById(`${prefix}-lng`).value = p.lng().toFixed(7);
    reverseGeocodeGoogle(prefix, p.lat(), p.lng());
  });
  reverseGeocodeGoogle(prefix, lat, lng);
}
function reverseGeocodeGoogle(prefix, lat, lng) {
  if (!geocoder) return;
  geocoder.geocode({ location: { lat, lng } }, (results, status) => {
    if (status === 'OK' && results[0]) {
      document.getElementById(`${prefix}-address`).value = results[0].formatted_address;
      const pc = results.find(r => r.plus_code);
      if (pc) document.getElementById(`${prefix}-pluscode`).value = pc.plus_code.global_code;
    }
  });
}
async function reverseGeocodeNominatim(prefix, lat, lng) {
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`, { headers: { 'Accept-Language': 'en' } });
    const data = await res.json();
    if (data?.display_name) document.getElementById(`${prefix}-address`).value = data.display_name;
    document.getElementById(`${prefix}-pluscode`).value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  } catch(e) {}
}
function showGPSError(prefix, msg) {
  document.getElementById(`${prefix}-accuracy`).innerHTML = `<span class="accuracy-badge poor">‚ö† ${msg}</span>`;
}

// ---- Form helpers ----
function handleOther(sel, otherId) {
  const div = document.getElementById(otherId);
  if (sel.value === 'Other') { div.classList.add('visible'); div.querySelector('input').focus(); }
  else { div.classList.remove('visible'); div.querySelector('input').value = ''; }
}
function getSelectValue(selId, otherValId) {
  const sel = document.getElementById(selId);
  if (sel.value === 'Other') {
    const t = document.getElementById(otherValId).value.trim();
    return t ? `Other: ${t}` : 'Other';
  }
  return sel.value;
}
function selectType(type) {
  currentType = type;
  document.getElementById('btn-business').classList.toggle('active', type === 'business');
  document.getElementById('btn-property').classList.toggle('active', type === 'property');
  document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
  document.getElementById(`section-${type}`).classList.add('active');
  document.getElementById('progressFill').style.width = '50%';
  document.getElementById('stepLabel').textContent = `Step 2 of 2 ‚Äî ${type === 'business' ? 'üè™ Business Details' : 'üè† Property Details'}`;
  setTimeout(() => document.getElementById(`section-${type}`).scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
}

// ---- Submit ----
async function submitForm(type) {
  const p = type === 'business' ? 'b' : 'p';
  if (type === 'business') {
    if (!document.getElementById('b-name').value.trim())    { showStatus('b','error','‚ö† Business Name is required.'); return; }
    if (!document.getElementById('b-contact').value.trim()) { showStatus('b','error','‚ö† Contact is required.'); return; }
    if (!document.getElementById('b-item').value.trim())    { showStatus('b','error','‚ö† Item / Product / Service is required.'); return; }
  }
  if (type === 'property') {
    if (!document.getElementById('p-owner').value.trim())   { showStatus('p','error',"‚ö† Property Owner's Name is required."); return; }
    if (!document.getElementById('p-contact').value.trim()) { showStatus('p','error','‚ö† Contact is required.'); return; }
  }
  if (!document.getElementById(`${p}-lat`).value) {
    showStatus(p, 'error', '‚ö† GPS not captured. Tap "Capture My Current Location" first.');
    return;
  }

  const lat = document.getElementById(`${p}-lat`).value;
  const lng = document.getElementById(`${p}-lng`).value;
  const now = new Date();

  const base = {
    _id:      `${Date.now()}-${Math.random().toString(36).slice(2,7)}`,
    type,
    timestamp: now.toLocaleString('en-GH', { timeZone: 'Africa/Accra' }),
    date:      now.toLocaleDateString('en-GH', { timeZone: 'Africa/Accra' }),
    latitude:  lat,
    longitude: lng,
    address:   document.getElementById(`${p}-address`).value,
    plusCode:  document.getElementById(`${p}-pluscode`).value,
    mapsLink:  `https://www.google.com/maps?q=${lat},${lng}`,
  };

  let record;
  if (type === 'business') {
    record = { ...base,
      businessName: document.getElementById('b-name').value,
      ownerName:    document.getElementById('b-owner').value,
      contact:      document.getElementById('b-contact').value,
      businessType: getSelectValue('b-type', 'b-type-other-val'),
      businessSize: getSelectValue('b-size', 'b-size-other-val'),
      item:         document.getElementById('b-item').value,
    };
  } else {
    record = { ...base,
      ownerName:      document.getElementById('p-owner').value,
      houseNumber:    document.getElementById('p-house').value,
      ghanaCard:      document.getElementById('p-ghana').value,
      contact:        document.getElementById('p-contact').value,
      suburb:         document.getElementById('p-suburb').value,
      buildingType:   getSelectValue('p-building-type', 'p-building-type-other-val'),
      numberOfRooms:  document.getElementById('p-rooms').value,
      numberOfFloors: getSelectValue('p-floors', 'p-floors-other-val'),
      currentUse:     getSelectValue('p-use', 'p-use-other-val'),
    };
  }

  showStatus(p, 'info', '‚è≥ Saving...');

  if (!navigator.onLine || APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') {
    offlineQueue.push(record);
    try { localStorage.setItem('rtf2026_queue', JSON.stringify(offlineQueue)); } catch(e) {}
    updateSyncStatus();
    sessionCount++;
    showSuccess(true);
    return;
  }

  try {
    await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(record) });
    sessionCount++;
    showSuccess(false);
    tryFlushQueue();
  } catch(e) {
    offlineQueue.push(record);
    try { localStorage.setItem('rtf2026_queue', JSON.stringify(offlineQueue)); } catch(ex) {}
    updateSyncStatus();
    sessionCount++;
    showSuccess(true);
  }
}

function showStatus(prefix, type, msg) {
  const el = document.getElementById(`${prefix}-status`);
  el.className = `status-msg ${type}`; el.textContent = msg;
}
function showSuccess(wasQueued) {
  document.getElementById('step1').style.display = 'none';
  document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
  document.getElementById('successScreen').classList.add('show');
  document.getElementById('progressFill').style.width = '100%';
  document.getElementById('stepLabel').textContent = 'Record submitted ‚úì';
  document.getElementById('successMsg').textContent = wasQueued
    ? `Saved offline ‚Äî will sync when connected. (${sessionCount} this session)`
    : `Synced to Google Sheets ‚úì ‚Äî ${sessionCount} record(s) this session.`;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function clearForm(type) {
  if (!confirm('Clear all fields?')) return;
  const p = type === 'business' ? 'b' : 'p';
  document.getElementById(`section-${type}`).querySelectorAll('input,select,textarea').forEach(el => el.value = '');
  document.querySelectorAll(`#section-${type} .other-field`).forEach(el => el.classList.remove('visible'));
  document.getElementById(`${p}-accuracy`).innerHTML = '';
  const c = document.getElementById(`${p}-map-container`);
  if (c) c.style.display = 'none';
  document.getElementById(`${p}-status`).className = 'status-msg';
}
function resetAll() {
  currentType = null;
  document.getElementById('step1').style.display = 'block';
  document.getElementById('successScreen').classList.remove('show');
  ['business','property'].forEach(t => document.getElementById(`section-${t}`).classList.remove('active'));
  document.getElementById('btn-business').classList.remove('active');
  document.getElementById('btn-property').classList.remove('active');
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('stepLabel').textContent = 'Step 1 of 2 ‚Äî Select Revenue Type';
  ['b','p'].forEach(p => {
    const btn = document.getElementById(`${p}-gps-btn`);
    if (btn) btn.querySelector('.btn-text').textContent = 'üì° Capture My Current Location';
  });
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

init();
</script>
</body>
</html>
